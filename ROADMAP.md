# Aither Flow — Дорожная карта

**Дата:** 2026-02-27
**Статус:** утверждена

Полная архитектура проекта: `ARCHITECTURE.md`

---

## Общие правила

### Для агента
- Перед началом работы прочитай `ARCHITECTURE.md` и `CLAUDE.md` (когда появится)
- Каждый этап = 1-2 сессии. Не лезь вперёд, делай только текущий этап
- Одно изменение за раз. Проверил — следующее. Никаких массовых правок
- Код на TypeScript и Rust. Фронтенд: React + Tailwind. Бэкенд: Tauri 2
- ESLint + Prettier + `cargo clippy` — запускай после каждого блока изменений
- Коммит после каждого логического блока, не копи изменения

### Для человека
- Каждый этап обсуждается перед началом. Агент не начинает без одобрения
- GitHub: пуш каждый день, даже если мало сделано
- Скилл `/claude-automation-recommender` — запустить в начале проекта.
  Он проанализирует что есть, предложит MCP-серверы, хуки, навыки
- Скилл `/feature-dev` — можно использовать для реализации отдельных фич

### GitHub
- Репозиторий создаётся на этапе 1
- Пуш в `main` каждый день (или чаще)
- Осмысленные коммиты (не «fix», а что конкретно сделано)
- README.md — обновляется по мере появления фич
- Лицензия: решить на этапе 1

---

## Этап 1 — Фундамент

**Цель:** пустой проект, который запускается и показывает окно. Ничего не
умеет, но собран правильно. Как пустая квартира после ремонта — стены ровные,
розетки на месте, мебели нет.

**Задачи:**
1. Создать Tauri 2 проект (Cargo workspace)
   - Основное приложение (tauri + react)
   - Заготовка `aither-flow-perms` (пустой crate, будет нужен позже)
2. Настроить фронтенд: React 19 + TypeScript + Vite + Tailwind CSS v4
3. Настроить линтеры: ESLint + Prettier (фронт), cargo clippy (Rust)
4. Gruvbox тема: CSS-переменные, dark/light, переключение
5. XDG-пути: `dirs` crate, все конфиги в `~/.config/aither-flow/`
6. `platform.rs` — модуль с заглушками для Linux/macOS
7. Выбрать и подключить icon pack (Lucide / Phosphor / Tabler)
8. Базовый компонент Modal (единый для всех будущих окон)
9. Создать GitHub-репозиторий, первый пуш
10. README.md с описанием проекта
11. Запустить `/claude-automation-recommender` — настроить окружение

**Результат:** `pnpm tauri dev` → открывается окно с логотипом Aither Flow.
Пустое, красивое, правильно собранное. Проект на GitHub.

**Проверка:** окно открывается, ESLint/clippy без ошибок, GitHub актуален.

---

## Этап 2 — Дирижёр (ядро)

**Цель:** приложение умеет запускать Claude CLI и получать ответы. Данные
ходят туда-обратно. В интерфейсе пока ничего не видно — всё в консоли.
Как провести электричество: ток есть, лампочку ещё не вкрутили.

**Задачи:**
1. Модуль ядра (Rust): запуск `claude` как subprocess
   - Флаги: `-p --output-format stream-json --input-format stream-json
     --verbose --include-partial-messages`
   - stdin (отправка) / stdout (приём) / stderr (ошибки)
2. Парсинг stream-json потока:
   - `system` (subtype: init) → инициализация
   - `stream_event` (content_block_delta) → частичный текст
   - `assistant` → полное сообщение
   - `result` → итог (стоимость, usage)
3. Шина событий: ядро получает событие → кидает подписчикам
   - Любой модуль может подписаться на события
   - Модули не знают друг о друге
4. Отправка сообщения: текст → stdin CLI
5. Остановка: kill процесса
6. Обработка ошибок: CLI не найден, упал, нет авторизации, таймаут

**Результат:** в консоли разработчика видно: отправил текст → пришёл ответ.

**Проверка:** послать «привет» → получить ответ в логах. Остановить → процесс убит.

---

## Этап 3 — Первая скрипка (чат)

**Цель:** чат работает. Написал вопрос — агент отвечает на экране в реальном
времени. Первый момент когда приложением можно пользоваться.

**Задачи:**
1. Компонент чата: список сообщений (пользователь / агент)
2. Поле ввода: Enter = отправить, Shift+Enter = новая строка
3. Стриминг: текст появляется по мере генерации (не ждём полный ответ)
4. Markdown в ответах: react-markdown + rehype-highlight
   - Заголовки, код с подсветкой, списки, ссылки, таблицы
   - Кнопка Copy на блоках кода
5. Кнопка Stop (остановить агент)
6. Индикатор «думает» (анимация)
7. Кнопка New Chat (сбросить и начать заново)
8. Smart-scroll: автопрокрутка вниз, остановка если пользователь прокрутил вверх

**Результат:** открыл → написал вопрос → агент отвечает в реальном времени.
Как мессенджер с ИИ.

**Проверка:** написать вопрос → ответ стримится → Stop работает → New Chat
сбрасывает. Markdown рендерится корректно.

---

## Этап 4 — Виолончель (проект и агент)

**Цель:** чат привязан к проекту. Агент работает в конкретной папке, видит
файлы, может их править. Без проекта агент — болтун. С проектом — работник.

**Задачи:**
1. Выбор проекта: диалог выбора папки (нативный)
2. CLI запускается с рабочей директорией проекта
3. Закладки проектов: сохранить, быстро переключить, переименовать
4. StatusBar: текущий проект, модель, стоимость, токены, % контекста
5. Выбор модели: sonnet / opus / haiku (ModelPicker)
6. Базовые настройки: модель, fallback-модель, уровень мышления (auto/light/deep)
7. Хедер: кнопки управления (тема, закрытие)

**Результат:** выбрал проект → агент работает в нём. Видно где ты и что делаешь.

**Проверка:** открыть проект → агент видит файлы → переключить модель → StatusBar
обновляется. Закладки сохраняются между запусками.

---

## Этап 5 — Контрабас (файлы и diff)

**Цель:** видишь что агент наменял. Зелёное — добавил, красное — удалил.
Можно принять или откатить. Контроль. Камера видеонаблюдения за строителями.

**Задачи:**
1. FileViewer: открыть файл, подсветка синтаксиса (hljs), номера строк
2. Автооткрытие: агент вызвал Edit/Write/MultiEdit → файл открывается
3. Diff: красные строки (удалено), зелёные (добавлено)
4. Accept / Reject: кнопки на каждой правке
5. MultiEdit: несколько правок в одном файле, каждая с accept/reject
6. Табы: несколько файлов одновременно (TabBar)
7. Просмотр картинок (SVG, PNG, JPG) с зумом
8. Дерево проекта (FileTree): рекурсивное, цветные иконки по типу файла

**Результат:** агент правит код → видишь каждое изменение → решаешь оставить
или нет.

**Проверка:** попросить агента создать файл → видишь diff → Accept → файл
сохранён. Reject → откат. Табы переключаются.

---

## Этап 6 — Фортепиано (настройки и раскладка)

**Цель:** приложение настраивается под тебя. Тема, раскладка, шрифты,
горячие клавиши. Как кресло, подстроенное под спину.

**Задачи:**
1. Settings: одно модальное окно, секции слева (как в браузере)
   - User: тема (dark/light), размер шрифта, семейство шрифта
   - Model: модель, fallback, уровень мышления, лимиты
   - Hotkeys: список горячих клавиш
2. Раскладка: горизонтальная / вертикальная (переключение)
3. Боковая панель: resizable (drag), toggle (показать/скрыть)
4. Горячие клавиши: Alt+комбинации, работают на любой раскладке (`e.code`)
5. Корректное закрытие: блокировка при активных агентах, graceful shutdown
6. Переменные окружения CLI: MAX_THINKING_TOKENS и пр.

**Результат:** выглядит и чувствуется как ТВОЁ приложение.

**Проверка:** переключить тему → всё перекрашивается. Изменить раскладку →
панели перестраиваются. Горячие клавиши работают на русской раскладке.

---

## Этап 7 — Вторая скрипка (мульти-агент)

**Цель:** несколько вкладок. Каждая — отдельный агент, отдельный процесс,
отдельный проект. Три окна терминала, но красивее.

**Задачи:**
1. AgentTabBar: вкладки агентов, +/× кнопки
2. Каждый агент = изолированный контейнер (свои сообщения, процесс, проект)
3. Переключение = показать другой контейнер (НЕ перенастройка общего стейта)
4. Фоновый агент работает пока переключился на другой
5. Предупреждение: два агента правят один файл
6. Лимит: максимум 10 агентов
7. Блокировка проекта: агент заблокирован в проекте после начала работы

**Результат:** 3 вкладки — 3 агента параллельно в разных проектах.

**Проверка:** открыть 3 вкладки → каждая работает независимо → переключение
не ломает стриминг → фоновый агент продолжает работать.

**Критически важно:** изоляция с первого дня. Не повторять ошибки V1 (C4-C8).

---

## Этап 8 — Чаты и память

**Цель:** чаты сохраняются. Память между сессиями. Закрыл — открыл через
неделю — всё на месте. Дневник, который всегда с собой.

**Задачи:**
1. Чаты: автосохранение, переименование, закрепление (pin)
2. Папки для чатов (создать, удалить, перетащить чат в папку)
3. Продолжение чата: `--resume <session_id>`
4. История чатов: панель в сайдбаре, список по проектам
5. Поиск по истории чатов (полнотекстовый)
6. Блокировка: чат открыт в одном агенте — другие не могут
7. Память: SQLite + FTS5, карточки (заголовок, категория, теги)
8. Скилл `/remember` — сохранить из сессии
9. Скилл `/recall` — прикрепить карточки как контекст
10. Панель памяти в сайдбаре: поиск, фильтр, карточки

**Результат:** данные живут между сессиями. Агент помнит важное.

**Проверка:** создать чат → закрыть → открыть → чат на месте. Сохранить
карточку → /recall → карточка прикрепилась.

---

## Этап 9 — Rewind (откат)

**Цель:** кнопка «Откатить» на каждом сообщении. Агент наворотил — нажал
кнопку — всё как было. Ctrl+Z для целого проекта. MUST HAVE.

**Задачи:**
1. Включить чекпоинты: `CLAUDE_CODE_ENABLE_SDK_FILE_CHECKPOINTING=1`
2. Флаг `--replay-user-messages` → UUID чекпоинтов в потоке
3. Кнопка «Откатить» на каждом сообщении пользователя
4. 4 варианта отката:
   - Файлы + разговор
   - Только файлы (разговор оставить)
   - Только разговор (файлы оставить)
   - Сжать разговор от этой точки
5. Предпросмотр: какие файлы изменятся при откате
6. Откат: `claude --resume <sid> --rewind-files <checkpoint-uuid>`

**Результат:** агент насрал в 5 файлов → «Откатить» → всё как было.

**Проверка:** попросить агента наворотить → откатить → файлы вернулись.
Попробовать каждый из 4 вариантов.

---

## Этап 10 — Духовые (навыки, MCP, агенты, хуки)

**Цель:** всё что расширяет возможности агента. Навыки, MCP-серверы,
роли агентов, хуки. Швейцарский нож. Большой этап, возможно 2 сессии.

**Задачи (навыки):**
1. SKILL.md формат (YAML frontmatter + промпт)
2. Библиотека навыков: список, поиск, управление
3. Избранные навыки (быстрый доступ)
4. Слэш-команды: /clear, /new, /model, /copy, /rc + автокомплит
5. Встроенные навыки: /remember, /recall

**Задачи (MCP-серверы):**
6. Добавить / удалить / редактировать MCP-сервер
7. Тест подключения
8. Импорт из Claude Desktop
9. OAuth: client-id / client-secret (маскировка, keychain)
10. Проектный .mcp.json

**Задачи (агенты):**
11. CRUD агентов (.md файлы с YAML frontmatter)
12. Глобальные (`~/.claude/agents/`) и проектные (`.claude/agents/`)
13. Передача `--agent <name>` при запуске CLI
14. Worktree isolation: чекбокс, `--worktree` флаг

**Задачи (хуки и разрешения):**
15. Визуальный редактор хуков (20 событий, 3 типа обработчиков)
16. Разрешения: allow / deny / ask правила
17. Интерактивные разрешения: `aither-flow-perms` (отдельный бинарник,
    unix socket → карточка Allow/Deny в чате)

**Результат:** агент подключен к внешним инструментам. Навыки автоматизируют
рутину. Хуки реагируют на события.

**Проверка:** добавить MCP-сервер → тест → работает. Создать навык →
использовать. Разрешение → карточка Allow/Deny появляется.

---

## Этап 11 — Ударные (инфраструктура)

**Цель:** всё что делает приложение удобнее. Можно жить и без этого, но с
этим — в разы приятнее. Приложение из чата превращается в рабочую среду.

**Задачи:**
1. Веб-превью: iframe, порты-закладки, проверка сервера, dev-серверы
2. Файловый менеджер: навигация от ~/, copy/paste/delete/rename, breadcrumbs
3. Поиск по проекту: файлы + содержимое (Alt+F)
4. Голосовой ввод: запись → Groq Whisper → текст в поле ввода
5. Статистика: графики расхода токенов и денег (SVG)
6. Отслеживание файлов: файл изменился на диске → обновить FileViewer и FileTree
7. Перетаскивание файлов в чат, вставка картинок из буфера
8. `@ filename` — контекст файла в поле ввода
9. Цитирование: выделить текст → Quote → `> prefix`
10. Сворачивание длинных сообщений (>6 строк)
11. Подсветка диапазонов строк, кликабельные ссылки на строки

**Результат:** полноценная рабочая среда. IDE, где вместо компилятора — ИИ.

**Проверка:** веб-превью показывает dev-сервер. Поиск находит файлы.
Голос → текст. Drag & drop работает.

---

## Этап 12 — Помощник дирижёра (внешний мир)

**Цель:** агент доступен не только из окна. Telegram, уведомления,
расписание, фоновая работа. Закрыл ноутбук — агент продолжает.
Как персональный ассистент, который не спит.

**Задачи (Telegram):**
1. Telegram-бот: отправка/приём сообщений
2. Стриминг ответов (editMessage, throttle 2-3 сек)
3. Дебаунс: 5 сообщений подряд → склеить в одно
4. Уведомления: задача готова, ошибка, ждёт ввода

**Задачи (фон):**
5. Фоновый демон: systemd user service (Linux) / launchd (macOS)
6. Иконка в трее: статус агентов, быстрое открытие окна
7. При закрытии: «Убить агентов или оставить в фоне?»
8. Крон-задачи: запуск по расписанию, результат в Telegram/уведомление

**Задачи (уведомления):**
9. Desktop-уведомления (нативные)
10. Каналы доставки: Telegram / desktop / webhook / звук

**Задачи (relay, позже):**
11. Relay-сервер: WebSocket, E2E-шифрование
12. Поддержка /rc (Remote Control от Anthropic)

**Результат:** агент доступен 24/7. Окно, Telegram, телефон.

**Проверка:** Telegram-бот отвечает. Крон запускает задачу. Закрыл окно —
агент в фоне. Иконка в трее показывает статус.

---

## Этап 13 — Полный оркестр (полировка)

**Цель:** разница между «работает» и «продуктом». Первое впечатление,
удобство, завершённость. Всё на месте, всё красивое.

**Задачи:**
1. Визард первого запуска (язык, стиль, уровень → генерация CLAUDE.md)
2. Редактор глобального CLAUDE.md
3. Перевод контента (описания навыков/MCP/агентов на язык пользователя)
4. Менеджер сессий (визуализация дерева сессий CLI)
5. Skill Sources (коллекции навыков из Git-репозиториев)
6. Project Saves (снимки проекта, как сейвы в играх)
7. Экспорт/импорт данных (чаты, память, настройки → архив)
8. Авторизация CLI: статус, перелогин
9. Запуск из терминала: `aither-flow --project /path --model opus`
10. Выбор бинарника Claude CLI (если несколько установок)
11. Кроссплатформа: тестирование на macOS, исправление багов
12. Плагины CLI (поиск, установка, запуск навыков)

**Результат:** полный оркестр играет. Продукт, который не стыдно показать.

**Проверка:** первый запуск → визард → CLAUDE.md создан. macOS → работает.
Экспорт → импорт на другой машине → всё на месте.

---

## Ключевые принципы (для агента)

1. **Один этап за раз.** Не забегай вперёд
2. **Одно изменение за раз.** Проверил — следующее
3. **Коммит после каждого логического блока.** Осмысленные сообщения
4. **Пуш каждый день.** GitHub всегда актуален
5. **Модули не знают друг о друге.** Шина событий, не прямые импорты
6. **Изоляция агентов с первого дня.** Не повторять ошибки V1
7. **XDG-пути.** `~/.config/aither-flow/`, `~/.local/share/aither-flow/`
8. **`platform.rs` с первого дня.** Никаких линуксовых хардкодов
9. **Не проглатывать ошибки.** Логировать всё, пустые catch запрещены
10. **Не изобретать.** Где CLI имеет формат — использовать его

---

## Инструменты агента

При старте проекта:
- `/claude-automation-recommender` — анализ и настройка окружения
  (MCP-серверы, хуки, навыки, плагины для проекта)

При разработке фич:
- `/feature-dev` — пошаговая разработка фичи с анализом архитектуры

Всегда:
- `/build-check` — проверка TypeScript + Rust после изменений
- `/remember` — сохранить важное в память сессии
